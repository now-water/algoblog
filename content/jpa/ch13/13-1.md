---
title: '(1) 트랜잭션 범위와 영속성 컨텍스트'
metaTitle: '만렙 개발자 키우기'
metaDescription: '트랜잭션 범위와 영속성 컨텍스트를 정리한 곳입니다.'
tags: ['Spring Boot JPA']
date: '2021-01-26'
---

## 스프링 컨테이너의 기본 전략

: 트랜잭션 범위의 영속성 컨텍스트 전략

- 트랜잭션의 범위와 영속성 컨텍스트의 생존 범위가 같다.

* 트랜잭션을 시작할 때 영속성 컨텍스트를 생성하고 트랜잭션이 끝날 때 영속성 컨텍스트를 종료한다.

- 같은 트랜잭션 안에서는 항상 같은 영속성 컨텍스트에 접근한다.

  - 다양한 위치에서 엔티티 매니저를 주입받아 사용해도 트랜잭션이 같으면 항상 같은 영속성 컨텍스트를 사용한다.

        예를 들면, Transaction 범위의 한 클래스에서 repo1 의 어떤 em.~~~() 수행하는 것과, repo2 의 em.~~!() 를 수행하는 것은

        둘 다 똑같은 영속성 컨텍스트를 사용하는 것.

  - 반면, 트랜잭션이 다르면 다른 영속성 컨텍스트를 사용

        Transaction 범위의 A 클래스, Transaction 범위의 B 클래스가

        한 repo의 em.~~() 를 동시에 사용해도 트랜잭션에 따라 접근하는 컨텍스트가 다르다.

        즉, 스프링 컨테이너는 스레드마다 각각 다른 트랜잭션을 할당한다. -> 멀티 스레드 상황에 안전함

비즈니스 로직을 처리하는 서비스 계층에 `@Transaction` 어노테이션을 선언해서 트랜잭션을 시작한다.

어노테이션이 붙은 메소드를 실행하기 직전에 스프링의 `트랜잭션 AOP`가 먼저 동작한다.
<br/>
<br/>

> **트랜잭션 AOP**
>
> > 대상 메소드를 호출하기 직전에 트랜잭션을 시작한다.
> >
> > 대상 메소드가 정상 종료되면 트랜잭션을 커밋하면서 종료한다.
> >
> > 트랜잭션 커밋 시, JPA 는 먼저 영속성 컨텍스트를 **플러시**해서 변경 내용을 DB에 반영 후 DB트랜잭션을 커밋한다.
>
> 예외 발생 시 트랜잭션을 **롤백**하고 종료한다.
